@model Business_School.ViewModels.Dashboard.DashboardClubLeaderVM
@{
    ViewData["Title"] = "Dashboard - Gestión del Club";
}

<div class="container-fluid mt-4">
    @if (string.IsNullOrEmpty(Model.ClubName))
    {
        <div class="alert alert-warning d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-2 fs-4"></i>
            <div>
                <strong>No lideras ningún club actualmente.</strong>
                <p class="mb-0 mt-1">Contacta con el administrador para que te asigne un club.</p>
            </div>
        </div>
    }
    else
    {
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1"><i class="bi bi-flag-fill text-primary"></i> Gestión del Club</h2>
                <p class="text-muted mb-0">Panel de control para líderes</p>
            </div>
            <form asp-controller="Account" asp-action="Logout" method="post" class="d-inline">
                <button type="submit" class="btn btn-danger">
                    <i class="bi bi-box-arrow-right"></i> Cerrar sesión
                </button>
            </form>
        </div>

        <!-- A. Tarjeta con información del Club -->
        <div class="card shadow-sm mb-4 border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Información del Club</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-8">
                        <h4 class="text-success mb-3">@Model.ClubName</h4>
                        <p class="text-muted mb-3">@Model.ClubDescription</p>
                        <p class="mb-2">
                            <i class="bi bi-building text-success"></i>
                            <strong>Departamento: @Model.DepartmentName</strong>
                          
                        </p>
                    </div>
                    <div class="col-lg-4 text-end d-flex flex-column justify-content-center gap-2">
                        <a asp-controller="Clubs" asp-action="Edit" asp-route-id="@Model.ClubId" class="btn btn-outline-success">
                            <i class="bi bi-pencil"></i> Editar Club
                        </a>
                        <a asp-controller="Clubs" asp-action="Details" asp-route-id="@Model.ClubId" class="btn btn-outline-info">
                            <i class="bi bi-eye"></i> Ver Detalles Públicos
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <hr />

        <!-- B. KPIs del Club -->
        <h4 class="mb-3"><i class="bi bi-speedometer2"></i> Estadísticas del Club</h4>
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="card shadow-sm border-primary h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-people-fill text-primary fs-1"></i>
                        <h6 class="card-subtitle mb-2 text-muted mt-2">Total Estudiantes</h6>
                        <h3 class="card-title text-primary mb-0">@Model.TotalStudents</h3>
                        <small class="text-muted">miembros activos</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow-sm border-info h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-calendar-event text-info fs-1"></i>
                        <h6 class="card-subtitle mb-2 text-muted mt-2">Eventos del Club</h6>
                        <h3 class="card-title text-info mb-0">@Model.TotalEvents</h3>
                        <small class="text-muted">eventos organizados</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow-sm border-warning h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-star-fill text-warning fs-1"></i>
                        <h6 class="card-subtitle mb-2 text-muted mt-2">Puntos Otorgados</h6>
                        <h3 class="card-title text-warning mb-0">@Model.TotalPointsAwarded</h3>
                        <small class="text-muted">puntos totales</small>
                    </div>
                </div>
            </div>
        </div>

        <hr />

        <!-- C. Estudiantes del Club -->
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0"><i class="bi bi-mortarboard-fill"></i> Estudiantes del Club</h4>
                <span class="badge bg-primary fs-6">@Model.Students.Count miembro@(Model.Students.Count != 1 ? "s" : "")</span>
            </div>

            @if (Model.Students.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover table-bordered align-middle">
                        <thead class="table-light">
                            <tr>
                                <th><i class="bi bi-person"></i> Nombre</th>
                                <th><i class="bi bi-envelope"></i> Email</th>
                                <th class="text-center"><i class="bi bi-star"></i> Puntos</th>
                                <th class="text-center"><i class="bi bi-bar-chart"></i> Nivel</th>
                                <th class="text-center"><i class="bi bi-calendar-plus"></i> Fecha de Ingreso</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var student in Model.Students)
                            {
                                <tr>
                                    <td>
                                        <strong>@student.FullName</strong>
                                    </td>
                                    <td>
                                        <a href="mailto:@student.Email" class="text-decoration-none">
                                            @student.Email
                                        </a>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-warning text-dark fs-6">
                                            <i class="bi bi-star-fill"></i> @student.Points
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        @{
                                            var levelClass = student.Level switch
                                            {
                                                Business_School.Models.StudentLevel.Principiante => "bg-secondary",
                                                Business_School.Models.StudentLevel.Intermedio => "bg-info",
                                                Business_School.Models.StudentLevel.Avanzado => "bg-primary",
                                                Business_School.Models.StudentLevel.Experto => "bg-success",
                                                _ => "bg-secondary"
                                            };
                                            var levelIcon = student.Level switch
                                            {
                                                Business_School.Models.StudentLevel.Principiante => "bi-emoji-smile",
                                                Business_School.Models.StudentLevel.Intermedio => "bi-emoji-sunglasses",
                                                Business_School.Models.StudentLevel.Avanzado => "bi-award",
                                                Business_School.Models.StudentLevel.Experto => "bi-gem",
                                                _ => "bi-person"
                                            };
                                        }
                                        <span class="badge @levelClass fs-6">
                                            <i class="bi @levelIcon"></i> @student.Level
                                        </span>
                                    </td>
                                    <td class="text-center">@student.JoinedAt.ToString("dd/MM/yyyy")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="card border-secondary">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-inbox fs-1 text-muted"></i>
                        <h5 class="text-muted mt-3">No hay estudiantes en este club todavía</h5>
                        <p class="text-muted mb-0">Los estudiantes pueden unirse desde la vista pública del club.</p>
                    </div>
                </div>
            }
        </div>

        <hr />

        <!-- D. Eventos del Club -->
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h4 class="mb-1"><i class="bi bi-calendar2-week"></i> Eventos del Club</h4>
                    <p class="text-muted mb-0 small">Gestiona los eventos que has creado para tu club</p>
                </div>
                <a asp-controller="Events" asp-action="Create" asp-route-clubId="@Model.ClubId" class="btn btn-success">
                    <i class="bi bi-plus-circle"></i> Crear Evento
                </a>
            </div>

            @if (Model.Events.Any())
            {
                <div class="row g-3">
                    @foreach (var ev in Model.Events)
                    {
                        var cardClass = ev.Status switch
                        {
                            "Abierto" => "border-success",
                            "Lleno" => "border-warning",
                            "Cerrado" => "border-secondary",
                            "En curso" => "border-primary",
                            _ => ""
                        };
                        var statusBadge = ev.Status switch
                        {
                            "Abierto" => "bg-success",
                            "Lleno" => "bg-warning text-dark",
                            "Cerrado" => "bg-secondary",
                            "En curso" => "bg-primary",
                            _ => "bg-secondary"
                        };
                        var statusIcon = ev.Status switch
                        {
                            "Abierto" => "bi-check-circle",
                            "Lleno" => "bi-exclamation-triangle",
                            "Cerrado" => "bi-x-circle",
                            "En curso" => "bi-play-circle",
                            _ => "bi-circle"
                        };

                        <div class="col-md-6 col-lg-4">
                            <div class="card shadow-sm h-100 @cardClass">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="card-title mb-0">@ev.Title</h5>
                                        <span class="badge @statusBadge">
                                            <i class="bi @statusIcon"></i> @ev.Status
                                        </span>
                                    </div>

                                    <p class="card-text text-muted small mb-2">
                                        <i class="bi bi-calendar"></i> @ev.StartDate.ToString("dd/MM/yyyy")
                                    </p>
                                    <p class="card-text text-muted small mb-3">
                                        <i class="bi bi-clock"></i> @ev.StartDate.ToString("HH:mm")
                                    </p>

                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="text-muted">Inscripciones:</small>
                                            <strong>@ev.RegisteredCount / @(ev.Capacity?.ToString() ?? "∞")</strong>
                                        </div>
                                        @if (ev.Capacity.HasValue)
                                        {
                                            var percentage = ev.Capacity > 0 ? (ev.RegisteredCount * 100.0 / ev.Capacity.Value) : 0;
                                            var progressClass = percentage switch
                                            {
                                                >= 100 => "bg-danger",
                                                >= 75 => "bg-warning",
                                                >= 50 => "bg-info",
                                                _ => "bg-success"
                                            };
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar @progressClass" role="progressbar" style="width: @percentage%" aria-valuenow="@ev.RegisteredCount" aria-valuemin="0" aria-valuemax="@ev.Capacity"></div>
                                            </div>
                                        }
                                    </div>

                                    <div class="d-grid gap-2">
                                        <div class="btn-group" role="group">
                                            <a asp-controller="Events" asp-action="Edit" asp-route-id="@ev.Id" class="btn btn-outline-primary btn-sm">
                                                <i class="bi bi-pencil"></i> Editar
                                            </a>
                                            <a asp-controller="Events" asp-action="Details" asp-route-id="@ev.Id" class="btn btn-outline-info btn-sm">
                                                <i class="bi bi-eye"></i> Ver
                                            </a>
                                            <a asp-controller="Events" asp-action="Attendees" asp-route-id="@ev.Id" class="btn btn-outline-secondary btn-sm">
                                                <i class="bi bi-people"></i> Asistentes
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <div class="alert alert-success d-flex align-items-start mt-3">
                    <i class="bi bi-lightbulb me-2 mt-1"></i>
                    <div>
                        <strong>Gestión de eventos:</strong>
                        <ul class="mb-0 mt-2 small">
                            <li>Puedes <strong>editar</strong> la información de tus eventos en cualquier momento</li>
                            <li>Revisa la lista de <strong>asistentes</strong> para conocer quién participará</li>
                            <li>Los estudiantes pueden <strong>registrarse</strong> desde la vista pública del evento</li>
                        </ul>
                    </div>
                </div>
            }
            else
            {
                <div class="card border-info">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-calendar-x fs-1 text-info"></i>
                        <h5 class="text-muted mt-3">No hay eventos asociados a este club</h5>
                        <p class="text-muted mb-3">Crea tu primer evento para empezar a involucrar a los miembros</p>
                        <a asp-controller="Events" asp-action="Create" asp-route-clubId="@Model.ClubId" class="btn btn-success">
                            <i class="bi bi-plus-circle"></i> Crear Primer Evento
                        </a>
                    </div>
                </div>
            }
        </div>

        <hr />

        <!-- E. Gráfica - Actividad mensual del Club -->
        <div class="mb-4">
            <h4 class="mb-3"><i class="bi bi-graph-up-arrow"></i> Actividad Mensual del Club</h4>
            <div class="card shadow-sm">
                <div class="card-body">
                    <canvas id="monthlyActivityChart" style="height:300px;"></canvas>
                </div>
                <div class="card-footer text-muted small">
                    <i class="bi bi-info-circle"></i> Muestra las inscripciones a eventos del club en los últimos 6 meses
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const labels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.MonthlyActivity.Keys.ToList()));
        const data = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.MonthlyActivity.Values.ToList()));

        if (labels.length > 0) {
            const ctx = document.getElementById('monthlyActivityChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Inscripciones a Eventos',
                        data: data,
                        backgroundColor: 'rgba(40, 167, 69, 0.6)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 2,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: { size: 14 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Inscripciones: ' + context.parsed.y;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0,
                                font: { size: 12 }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                font: { size: 12 }
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        } else {
            document.getElementById('monthlyActivityChart').parentElement.innerHTML =
                '<div class="text-center text-muted py-5">' +
                '<i class="bi bi-bar-chart fs-1"></i>' +
                '<p class="mt-3">No hay datos de actividad disponibles aún.</p>' +
                '<small>Los datos aparecerán cuando los estudiantes se registren en eventos.</small>' +
                '</div>';
        }
    </script>
}