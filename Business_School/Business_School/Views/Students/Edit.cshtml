@model Business_School.ViewModels.Students.StudentFormVM
@{
    ViewData["Title"] = "Editar Estudiante";

    // Inicializar la URL de regreso según rol y ReturnUrl
    string backUrl;

    if (!string.IsNullOrWhiteSpace(Model.ReturnUrl) && Url.IsLocalUrl(Model.ReturnUrl))
    {
        // Si hay ReturnUrl válida, respetarla
        backUrl = Model.ReturnUrl;
    }
    else if (User.IsInRole("Student"))
    {
        // Si es estudiante y no hay ReturnUrl, ir a su dashboard
        backUrl = Url.Action("StudentDashboard", "Dashboard");
    }
    else
    {
        // Cualquier otro rol sin ReturnUrl, fallback al Admin Dashboard
        backUrl = Url.Action("Admin", "Dashboard");
    }
}

<div class="container mt-5">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="bi bi-pencil-square"></i> Editar Estudiante</h4>
        </div>
        <div class="card-body">
            <form asp-action="Edit" method="post">
                <input type="hidden" asp-for="Id" />
                <input type="hidden" asp-for="ReturnUrl" value="@backUrl" />

                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label asp-for="FullName" class="form-label"></label>
                        <input asp-for="FullName" class="form-control" />
                        <span asp-validation-for="FullName" class="text-danger"></span>
                    </div>
                    <div class="col-md-6">
                        <label asp-for="Email" class="form-label"></label>
                        <input asp-for="Email" class="form-control" />
                        <span asp-validation-for="Email" class="text-danger"></span>
                    </div>
                </div>

                @if (User.IsInRole("Admin"))
                {
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label asp-for="Points" class="form-label"></label>
                            <input asp-for="Points" class="form-control" />
                            <span asp-validation-for="Points" class="text-danger"></span>
                        </div>
                    </div>
                }

                <div class="mb-4">
                    <label class="form-label">Clubs</label>
                    <select name="SelectedClubIds" id="clubsSelect" class="form-select" multiple size="6">
                        @foreach (var club in Model.Clubs)
                        {
                            var selected = Model.SelectedClubIds.Contains(int.Parse(club.Value)) ? "selected" : null;
                            <option value="@club.Value" selected="@selected">@club.Text</option>
                        }
                    </select>
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success"><i class="bi bi-check-lg"></i> Guardar</button>
                    <a href="@backUrl" class="btn btn-secondary"><i class="bi bi-x-lg"></i> Cancelar</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.querySelector('form');

            function showError(fieldName, message) {
                const input = document.querySelector('[name="' + fieldName + '"]');
                if (input) {
                    const errorSpan = input.parentElement.querySelector('.text-danger');
                    if (errorSpan) {
                        errorSpan.textContent = message;
                    }
                    input.classList.add('is-invalid');
                }
            }

            function clearErrors() {
                document.querySelectorAll('.text-danger').forEach(span => {
                    span.textContent = '';
                });
                document.querySelectorAll('.is-invalid').forEach(input => {
                    input.classList.remove('is-invalid');
                });
            }

            function validateForm() {
                let isValid = true;
                clearErrors();

                const fullName = document.querySelector('[name="FullName"]');
                if (!fullName.value.trim()) {
                    showError('FullName', 'El nombre completo es obligatorio.');
                    isValid = false;
                } else if (fullName.value.trim().length < 3) {
                    showError('FullName', 'El nombre debe tener al menos 3 caracteres.');
                    isValid = false;
                }

                const email = document.querySelector('[name="Email"]');
                const emailRegex = /\S+@@\S+\.\S+/;
                if (!email.value.trim()) {
                    showError('Email', 'El email es obligatorio.');
                    isValid = false;
                } else if (!emailRegex.test(email.value.trim())) {
                    showError('Email', 'Ingresa un email válido.');
                    isValid = false;
                }

                const points = document.querySelector('[name="Points"]');
                if (points && points.value.trim()) {
                    const pointsValue = parseInt(points.value);
                    if (isNaN(pointsValue) || pointsValue < 0) {
                        showError('Points', 'Los puntos deben ser un número mayor o igual a 0.');
                        isValid = false;
                    }
                }

                return isValid;
            }

            form.addEventListener('submit', function (e) {
                if (!validateForm()) {
                    e.preventDefault();
                }
            });
        });
    </script>
}