@using Business_School.ViewModels
@model DepartmentFormViewModel

@{
    ViewData["Title"] = "Crear Departamento";
}

<h2 class="mt-4 mb-4 text-primary fw-bold">
    <i class="bi bi-building-add"></i> Crear Nuevo Departamento
</h2>

<div class="card shadow-sm border-0">
    <div class="card-header bg-primary text-white fw-semibold">
        Información del Departamento
    </div>

    <div class="card-body p-4">

        <form id="createDepartmentForm" asp-action="Create" method="post">
            @Html.AntiForgeryToken()

            <!-- Alert de errores -->
            <div id="formAlert" class="alert alert-danger d-none mb-4" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <span id="alertMessage"></span>
            </div>

            <div class="row g-3">

                <!-- Name -->
                <div class="col-md-6">
                    <label asp-for="Department.Name" class="form-label fw-semibold"></label>
                    <input asp-for="Department.Name" class="form-control" placeholder="Ej: Marketing & Ventas" />
                    <span data-valmsg-for="Department.Name" class="text-danger small"></span>
                </div>

                <!-- Email -->
                <div class="col-md-6">
                    <label asp-for="Department.Email" class="form-label fw-semibold"></label>
                    <input asp-for="Department.Email" class="form-control" placeholder="departamento@school.com" />
                    <span data-valmsg-for="Department.Email" class="text-danger small"></span>
                </div>

                <!-- Phone -->
                <div class="col-md-6">
                    <label asp-for="Department.PhoneNumber" class="form-label fw-semibold"></label>
                    <input asp-for="Department.PhoneNumber" class="form-control" placeholder="+34 600 123 456" />
                    <span data-valmsg-for="Department.PhoneNumber" class="text-danger small"></span>
                </div>

                <!-- Office Location -->
                <div class="col-md-6">
                    <label asp-for="Department.OfficeLocation" class="form-label fw-semibold"></label>
                    <input asp-for="Department.OfficeLocation" class="form-control" placeholder="Oficina 3B, Edificio Central" />
                    <span data-valmsg-for="Department.OfficeLocation" class="text-danger small"></span>
                </div>

                <!-- Manager dropdown -->
                <div class="col-md-6">
                    <label for="managerDropdown" class="form-label fw-semibold">Manager del Departamento</label>
                    <select asp-for="Department.ManagerUserId"
                            asp-items="@(new SelectList(Model.Managers, "Id", "FullName"))"
                            id="managerDropdown"
                            class="form-select">
                        <option value="">-- Seleccionar Manager --</option>
                    </select>
                    <span data-valmsg-for="Department.ManagerUserId" class="text-danger small"></span>
                </div>

            </div>

            <!-- Buttons -->
            <div class="mt-4 d-flex gap-2">
                <button type="submit" class="btn btn-success px-4">
                    <i class="bi bi-check-lg"></i> Crear
                </button>

                <a asp-action="Index" class="btn btn-outline-secondary px-4">
                    <i class="bi bi-x-lg"></i> Cancelar
                </a>
            </div>

        </form>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById('createDepartmentForm');
            const alertDiv = document.getElementById('formAlert');
            const alertMessage = document.getElementById('alertMessage');
            
            // Show error function
            function showError(elementId, message) {
                const errorSpan = document.querySelector(`[data-valmsg-for="${elementId}"]`);
                if (errorSpan) {
                    errorSpan.textContent = message;
                    errorSpan.classList.add('text-danger');
                }
            }
            
            // Clear all errors
            function clearErrors() {
                document.querySelectorAll('[data-valmsg-for]').forEach(span => {
                    span.textContent = '';
                    span.classList.remove('text-danger');
                });
                alertDiv.classList.add('d-none');
            }
            
            // Validate form
            function validateForm() {
                let isValid = true;
                clearErrors();
                
                // Name validation
                const name = document.querySelector('#Department_Name');
                if (!name.value.trim()) {
                    showError('Department.Name', 'El nombre del departamento es obligatorio.');
                    isValid = false;
                } else if (name.value.trim().length < 3) {
                    showError('Department.Name', 'El nombre debe tener al menos 3 caracteres.');
                    isValid = false;
                }

                       // Email validation
        const email = document.querySelector('#Department_Email');
        const emailRegex = new RegExp('^[^\\s@@]+@@[^\\s@@]+\\.[^\\s@@]+$');
        if (!email.value.trim()) {
            showError('Department.Email', 'El email es obligatorio.');
            isValid = false;
        } else if (!emailRegex.test(email.value.trim())) {
            showError('Department.Email', 'Ingresa un email válido (ej: nombre@@dominio.com).');
            isValid = false;
        }
                
                // Phone validation
                const phone = document.querySelector('#Department_PhoneNumber');
                const phoneRegex = new RegExp(`^[\\+]?[0-9\\s\\-\\(\\)]{7,15}$`);
                if (!phone.value.trim()) {
                    showError('Department.PhoneNumber', 'El teléfono es obligatorio.');
                    isValid = false;
                } else if (!phoneRegex.test(phone.value.replace(/\s+/g, ''))) {
                    showError('Department.PhoneNumber', 'Ingresa un teléfono válido (ej: +34 600 123 456).');
                    isValid = false;
                }
                
                // Office location validation
                const office = document.querySelector('#Department_OfficeLocation');
                if (!office.value.trim()) {
                    showError('Department.OfficeLocation', 'La ubicación de la oficina es obligatoria.');
                    isValid = false;
                }
                
                // Manager validation
                const manager = document.querySelector('#Department_ManagerUserId');
                if (!manager.value) {
                    showError('Department.ManagerUserId', 'Selecciona un manager para el departamento.');
                    isValid = false;
                }
                
                // Show alert if invalid
                if (!isValid) {
                    alertDiv.classList.remove('d-none');
                    alertMessage.textContent = 'Por favor, corrige los errores marcados en el formulario.';
                    
                    // Scroll to first error
                    const firstError = document.querySelector('.text-danger');
                    if (firstError) {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                
                return isValid;
            }
            
            // Form submit event
            form.addEventListener('submit', function (e) {
                if (!validateForm()) {
                    e.preventDefault();
                }
            });
            
            // Real-time validation on input change
            const inputs = form.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('blur', function () {
                    if (this.value.trim() === '' && this.hasAttribute('required')) {
                        const fieldName = this.id;
                        showError(fieldName, 'Este campo es obligatorio.');
                    }
                });
                
                input.addEventListener('input', function () {
                    const fieldName = this.id;
                    const errorSpan = document.querySelector(`[data-valmsg-for="${fieldName}"]`);
                    if (errorSpan && this.value.trim() !== '') {
                        errorSpan.textContent = '';
                        errorSpan.classList.remove('text-danger');
                    }
                });
            });
        });
    </script>
}